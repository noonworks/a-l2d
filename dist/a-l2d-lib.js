!function(t){var e={};function i(o){if(e[o])return e[o].exports;var s=e[o]={i:o,l:!1,exports:{}};return t[o].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(o,s,function(e){return t[e]}.bind(null,s));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=2)}([function(t,e){t.exports=THREE},function(t,e){t.exports=PIXI},function(t,e,i){"use strict";i.r(e);var o=i(0),s=i(1);class n{constructor(t,e){this._items=t,this._loop=e}get length(){return this._items.length}get items(){return this._items}}class r extends n{constructor(t,e){super(t,e),this._index=0}next(){if(0===this._items.length)return{done:!0,value:null};if(this._index>=this._items.length){if(!this._loop)return{done:!0,value:null};this._index=this._index%this._items.length}return{done:!1,value:this._items[this._index++]}}}class a extends n{constructor(t,e,i){super(t,e),this._pool=[],this._unique=i,this._counter=0}next(){return 0===this._items.length?{done:!0,value:null}:!this._loop&&(this._counter++,this._counter>this._items.length)?{done:!0,value:null}:{done:!1,value:this._items[this.getRandomIndex()]}}getRandomIndex(){return this._unique?(0===this._pool.length&&this.resetPool(),this._pool.pop()):Math.floor(Math.random()*this._items.length)}resetPool(){this._pool=Array.from(Array(this._items.length),(t,e)=>e);for(let t=this._pool.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1)),i=this._pool[t];this._pool[t]=this._pool[e],this._pool[e]=i}}}class l{constructor(t){this._asset=t,this._model=this._asset.model,this._basicItr=this.makeMotionIterator(this._asset.source.motions.basic),this._clickItr=this.makeMotionIterator(this._asset.source.motions.click),this.setup()}get model(){return this._model}get motionFinished(){const t=this._model.animator.getLayer("motion");return t&&t.currentTime>=t.currentAnimation.duration}get motionLayer(){return this._model.animator.getLayer("motion")}doMotion(t){if(!this.motionLayer)return;const e=t.next();e.done||null===e.value||(this.motionLayer.stop(),this.motionLayer.play(this._asset.motions[e.value]))}playBasic(){this.doMotion(this._basicItr)}playClick(){this.doMotion(this._clickItr)}setup(){this._model.pos_x=this._asset.source.x,this._model.pos_y=this._asset.source.y;const t=LIVE2DCUBISMFRAMEWORK.BuiltinAnimationBlenders.OVERRIDE;this._model.animator.addLayer("motion",t,1),this.playBasic()}makeMotionIterator(t){switch(t.order||"random"){case"order":return new r(t.values,!0);case"unique-random":return new a(t.values,!0,!0);case"random":default:return new a(t.values,!0,!1)}}}const h="model3",d="motion";var u;!function(t){t.JSON="json"}(u||(u={}));const c={xhrType:u.JSON};class p{load(t){return new Promise((e,i)=>{this.pixiLoad([{name:"src",url:t}],(o,s)=>{const n=this.getResult(s,"src",i);if(!n)return;const r=n.data;r?Promise.all(r.models.map(e=>this.loadModel(e,t))).then(e).catch(i):i(new Error("Could not parse src ["+t+"]."))},i)})}pixiLoad(t,e,i){const o=new PIXI.Loader;for(const e of t)o.add(e.name,e.url,c);o.load((t,o)=>{try{e(t,o)}catch(t){i(t)}})}getResult(t,e,i){const o=t[e];return o?o.error?(i(o.error),null):o:(i(new Error("Could not load ["+e+"].")),null)}loadModel(t,e){return new Promise((i,o)=>{if(t.assets)try{const s=Object.keys(t.assets).map(e=>({name:e,url:t.assets[e]}));this.pixiLoad(s,(s,n)=>{const r=LIVE2DCUBISMFRAMEWORK.Animation,a=Object.keys(n).filter(t=>t.startsWith(d)).reduce((t,e)=>{const i=n[e];return i&&(t[e]=r.fromMotion3Json(i.data)),t},{});(new LIVE2DCUBISMPIXI.ModelBuilder).buildFromModel3Json(s,n[h],s=>{if(null!=s)try{i({model:s,motions:a,source:t,url:e})}catch(t){o(t)}else o(new Error("model not found."))})},o)}catch(t){o(t)}else o(new Error("Could not load assets. [assets] not found in JSON."))})}}const m="l2d",_={_marker:null,_mesh:null,_models:[],_orientationchanged:!1,_pixiapp:null,multiple:!0,schema:{src:{type:"asset"},textureWidth:{type:"int",default:512},textureHeight:{type:"int",default:512}},loadState:{initialized:!1,assetLoading:{finished:!1,error:null}},_initPixiApp:function(){this._pixiapp=new s.Application({width:0,height:0,transparent:!0});const t=new o.Texture(this._pixiapp.view);t.premultiplyAlpha=!0;const e=new o.MeshStandardMaterial({});e.map=t,e.metalness=0,e.premultipliedAlpha=!0,e.transparent=!0;const i=this.el;if(!i)throw new Error("Element [el] not found.");if(this._mesh=i.getObject3D("mesh"),!this._mesh)throw new Error("Mesh [mesh] not found.");this._mesh.material=e},init:function(){const t=this.el;if(!t)throw new Error("Element [el] not found.");this._marker=t.parentNode,this._mesh=this._mesh,this._models=this._models||[],this._orientationchanged=this._orientationchanged||!1,this._pixiapp=this._pixiapp,this._initPixiApp();const e=void 0===window.ontouchstart?"click":"touchstart";window.addEventListener(e,()=>{for(const t of this._models)t.playClick()}),window.addEventListener("orientationchange",()=>{this._pixiapp&&(this._pixiapp.stage.renderable=!1),this._orientationchanged=!0}),t.object3D.front=new o.Object3D,t.object3D.front.position.set(0,0,-1),t.object3D.add(t.object3D.front),this.loadState=this.loadState,this.loadState.initialized=!0},_setTextureSize:function(){if(!this._mesh||!this.data||!this._pixiapp)return;const t=this.data.textureWidth,e=this.data.textureHeight;this._pixiapp.view.width=t,this._pixiapp.view.height=e,this._pixiapp.renderer.resize(t,e);for(const i of this._models)i.model.position=new s.Point(t*i.model.pos_x,e*i.model.pos_y),i.model.scale=new s.Point(.5*t,.5*e),i.model.masks.resize(this._pixiapp.view.width,this._pixiapp.view.height);this._mesh.material.map.needsUpdate=!0},_updateAsset:function(t){t&&this.data&&t.src==this.data.src||this.data&&(this.loadState.assetLoading.finished=!1,this.loadState.assetLoading.error=null,(new p).load(this.data.src).then(t=>{if(this.loadState.assetLoading.finished=!0,this.data)if(this._models=t.map(t=>new l(t)),this._initPixiApp(),this._pixiapp)try{!function(t,e){for(const i of t)e.stage.addChild(i.model),e.stage.addChild(i.model.masks);e.stage.renderable=!1,e.ticker.add(i=>{for(const o of t)o.model.update(i),o.model.masks.update(e.renderer)})}(this._models,this._pixiapp),this._setTextureSize()}catch(t){this.loadState.assetLoading.error=t}else this.loadState.assetLoading.error=new Error("Pixiapp [pixiapp] not found.");else this.loadState.assetLoading.error=new Error("Could not find data.src.")}).catch(t=>{this.loadState.assetLoading.error=t}))},update:function(t){this._setTextureSize(),this._updateAsset(t)},tick:function(){if(this._marker)if(this._marker.object3D.visible){if(!this._pixiapp)return;this._orientationchanged||(this._pixiapp.stage.renderable=!0),this._mesh&&(this._mesh.material.map.needsUpdate=!0);for(const t of this._models)t.motionFinished&&t.playBasic()}else this._pixiapp&&(this._pixiapp.stage.renderable=!1),this._orientationchanged=!1}},f=AFRAME.utils.extendDeep,g=AFRAME.primitives.getMeshMixin(),x="a-"+m,w=f({},g,{defaultComponents:{geometry:{primitive:"plane",width:5,height:5},material:{color:"#000"},position:{x:0,y:0,z:0},rotation:{x:-90,y:0,z:0},[m]:{}},mappings:{width:"geometry.width",height:"geometry.height",color:"material.color",textureWidth:m+".textureWidth",textureHeight:m+".textureHeight",src:m+".src"}});function y(t){const e=t.components;if(!e)return null;const i=e[m];return i||null}function v(t){return Array.from(t.querySelectorAll(x)).map(t=>y(t)).filter(t=>null!=t)}function A(){AFRAME.registerComponent(m,_),AFRAME.registerPrimitive(x,w)}function b(t){const e="[A-L2D ERROR] "+t.message;console.log(e),console.log(t),alert("[A-L2D] エラーが発生しました。\n"+e)}i.d(e,"getComponent",(function(){return y})),i.d(e,"getComponents",(function(){return v})),i.d(e,"register",(function(){return A})),i.d(e,"AL2D",(function(){return M}));const E={timeout:1e4,showAlert:!0};class M{constructor(t){this._registerError=null,this._opt=Object.assign(Object.assign({},E),t||{})}get registerError(){return this._registerError}doInit(){try{A()}catch(t){this._registerError=t,this._opt.showAlert&&b(t)}}init(){this._opt.showAlert?this.initAsync().then():this.doInit()}initAsync(){return this.doInit(),new Promise((t,e)=>{let i=this._opt.timeout/100;const o=()=>{try{const s=v(document);for(const t of s)if(!t.loadState.assetLoading.finished){if(--i<0){const t=new Error("Timeout for asset loading.");return this._opt.showAlert&&b(t),void e(t)}return void window.setTimeout(o,100)}if(b){!function(t){0!=t.length&&(1!=t.length?b(new Error(t.length+"個のエラーが発生しました。\n"+t[0].message)):b(t[0]))}(s.map(t=>t.loadState.assetLoading.error).filter(t=>null!=t))}t(s)}catch(t){e(t)}};o()})}}}]);